name: 'Chromatic'

on:
 push:
   branches: [ develop ]
 pull_request:
   branches: [ develop ]

permissions:
 contents: read
 pull-requests: write

jobs:
 chromatic:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v3
       with:
         fetch-depth: 0
     
     - name: Install dependencies
       run: npm install

     - name: Publish to Chromatic
       id: chromatic
       uses: chromaui/action@v1
       with:
         projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
         exitOnceUploaded: true
         autoAcceptChanges: 'develop'
         onlyChanged: true

     - name: Comment PR
       if: github.event_name == 'pull_request'
       uses: actions/github-script@v6
       with:
         script: |
           const storybookUrl = ${{ steps.chromatic.outputs.storybookUrl }};
           
           const comment = `## Storybook 확인 [ 바로가기 ](${storybookUrl})`;
           
           await github.rest.issues.createComment({
             issue_number: context.issue.number,
             owner: context.repo.owner,
             repo: context.repo.repo,
             body: comment
           });
